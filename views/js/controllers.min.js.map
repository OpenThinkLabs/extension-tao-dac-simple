{"version":3,"sources":["routes.js","admin/line!tpl","admin/index.js"],"names":["define","AdminAccessController","css","actions","adminPermissions","hb","template","Handlebars","depth0","helpers","partials","data","this","compilerInfo","merge","stack1","helper","options","buffer","functionType","escapeExpression","helperMissing","label","call","hash","type","user","__","$","_","lineTpl","feedback","autocomplete","httpErrorParser","linesThreshold","errorMsgManagePermission","tooltipConfigManagePermission","theme","content","text","_checkManagers","container","$managers","find","checkOk","length","_preventManagerRemoval","$form","closest","$submitter","qtip","removeClass","addClass","warning","_disableAccessOnGrant","$container","$managersChecked","$cantChangeWrite","$cantChangeRead","not","$canChangeWrite","$canChangeRead","attr","_disableAccessOnWrite","$writersChecked","$writers","_deletePermission","element","$this","isEmpty","remove","_manageTabsDisplay","_checkPermission","id","$btn","$line","effect","_addPermission","$body","first","append","_installListeners","on","event","preventDefault","$focused","index","$tabs","needsTabs","show","hasClass","Math","max","tabs","selected","active","hide","_searchFactory","isFunction","onSelectItem","assign","isProvider","preventSubmit","mainCtrl","start","value","focus","e","stopImmediatePropagation","error","ajax","url","serialize","global","done","success","fail","jqXHR","textStatus","errorThrown","parse","message","complete"],"mappings":"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","file":"routes.js","sourcesContent":["/**\r\n * This program is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU General Public License\r\n * as published by the Free Software Foundation; under version 2\r\n * of the License (non-upgradable).\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU General Public License\r\n * along with this program; if not, write to the Free Software\r\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\r\n *\r\n * Copyright (c) 2014 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\r\n *\r\n *\r\n */\r\n\r\ndefine('taoDacSimple/controller/routes',[],function(){\r\n    'user strict';\r\n    return {\r\n        'AdminAccessController' : {\r\n            'css': 'admin', \r\n            'actions' : {\r\n                'adminPermissions' : 'controller/admin/index'\r\n            }\r\n        }\r\n    };\r\n});\r\n\n","\ndefine('tpl!taoDacSimple/controller/admin/line', ['handlebars'], function(hb){ \nreturn hb.template(function (Handlebars,depth0,helpers,partials,data) {\n  this.compilerInfo = [4,'>= 1.0.0'];\nhelpers = this.merge(helpers, Handlebars.helpers); data = data || {};\n  var buffer = \"\", stack1, helper, options, functionType=\"function\", escapeExpression=this.escapeExpression, helperMissing=helpers.helperMissing;\n\n\n  buffer += \"<tr>\\r\\n    <td>\";\n  if (helper = helpers.label) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.label); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"</td>\\r\\n    <td>\\r\\n        \";\n  if (helper = helpers.type) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.type); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"\\r\\n        <input type=\\\"hidden\\\" name=\\\"users[\";\n  if (helper = helpers.user) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.user); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"][type]\\\" value=\\\"\";\n  if (helper = helpers.type) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.type); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"\\\">\\r\\n    </td>\\r\\n    <td>\\r\\n        <label class=\\\"tooltip\\\">\\r\\n            <input type=\\\"checkbox\\\" class=\\\"privilege-GRANT\\\" name=\\\"users[\";\n  if (helper = helpers.user) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.user); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"][GRANT]\\\" value=\\\"1\\\">\\r\\n            <span class=\\\"icon-checkbox\\\"></span>\\r\\n        </label>\\r\\n    </td>\\r\\n    <td>\\r\\n        <label class=\\\"tooltip\\\">\\r\\n            <input type=\\\"checkbox\\\" class=\\\"privilege-WRITE\\\" name=\\\"users[\";\n  if (helper = helpers.user) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.user); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"][WRITE]\\\" value=\\\"1\\\" checked>\\r\\n            <span class=\\\"icon-checkbox\\\"></span>\\r\\n        </label>\\r\\n    </td>\\r\\n    <td>\\r\\n        <label class=\\\"tooltip\\\">\\r\\n            <input type=\\\"checkbox\\\" class=\\\"privilege-READ\\\" name=\\\"users[\";\n  if (helper = helpers.user) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.user); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"][READ]\\\" value=\\\"1\\\" checked>\\r\\n            <span class=\\\"icon-checkbox\\\"></span>\\r\\n        </label>\\r\\n    </td>\\r\\n    <td>\\r\\n        <button type=\\\"button\\\" class=\\\"small delete_permission tooltip btn-warning\\\" data-acl-user=\\\"\";\n  if (helper = helpers.user) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.user); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"\\\" data-acl-type=\\\"\";\n  if (helper = helpers.type) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.type); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"\\\" data-acl-label=\\\"\";\n  if (helper = helpers.label) { stack1 = helper.call(depth0, {hash:{},data:data}); }\n  else { helper = (depth0 && depth0.label); stack1 = typeof helper === functionType ? helper.call(depth0, {hash:{},data:data}) : helper; }\n  buffer += escapeExpression(stack1)\n    + \"\\\" >\\r\\n            <span class=\\\"icon-bin\\\"></span>\"\n    + escapeExpression((helper = helpers.__ || (depth0 && depth0.__),options={hash:{},data:data},helper ? helper.call(depth0, \"Remove\", options) : helperMissing.call(depth0, \"__\", \"Remove\", options)))\n    + \"\\r\\n        </button>\\r\\n    </td>\\r\\n</tr>\\r\\n\";\n  return buffer;\n  });\n});\n\n","/**\r\n * This program is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU General Public License\r\n * as published by the Free Software Foundation; under version 2\r\n * of the License (non-upgradable).\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU General Public License\r\n * along with this program; if not, write to the Free Software\r\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\r\n *\r\n * Copyright (c) 2015 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\r\n */\r\ndefine('taoDacSimple/controller/admin/index',[\r\n    'jquery',\r\n    'lodash',\r\n    'i18n',\r\n    'tpl!taoDacSimple/controller/admin/line',\r\n    'helpers',\r\n    'ui/feedback',\r\n    'ui/autocomplete',\r\n    'util/httpErrorParser',\r\n    'ui/tooltip',\r\n    'jqueryui'\r\n], function ($, _, __, lineTpl, helpers, feedback, autocomplete, httpErrorParser) {\r\n    'use strict';\r\n\r\n    /**\r\n     * The amount of displayed lines that fires the tabs mode\r\n     * @type {Number}\r\n     */\r\n    var linesThreshold = 10;\r\n\r\n    /**\r\n     * The warning message shown when all managers have been removed\r\n     * @type {String}\r\n     */\r\n    var errorMsgManagePermission = __('You must have one role or user that have the manage permission on this element.');\r\n\r\n    /**\r\n     * Config object needed by the tooltip used to display warning if all managers have been removed\r\n     * @type {Object}\r\n     */\r\n    var tooltipConfigManagePermission = {\r\n        theme : 'warning',\r\n        content: {\r\n            text: __(errorMsgManagePermission)\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Checks the managers, we need at least one activated manager.\r\n     * @param {jQuery|Element|String} container\r\n     * @returns {Boolean} Returns `true` if there is at least one manager in the list\r\n     * @private\r\n     */\r\n    var _checkManagers = function (container) {\r\n        var $managers = $(container).find('.privilege-GRANT:checked');\r\n        var checkOk = true;\r\n\r\n        if (!$managers.length) {\r\n            checkOk = false;\r\n        }\r\n        return checkOk;\r\n    };\r\n\r\n    /**\r\n     * Avoids to remove all managers\r\n     * @param {jQuery|Element|String} container\r\n     * @private\r\n     */\r\n    var _preventManagerRemoval = function(container){\r\n        var $form = $(container).closest('form');\r\n        var $submitter = $(':submit', $form);\r\n\r\n        $submitter.qtip(tooltipConfigManagePermission);\r\n        if (!_checkManagers($form)) {\r\n            $submitter.addClass('disabled');\r\n            $submitter.qtip('enable');\r\n            feedback().warning(errorMsgManagePermission);\r\n        } else {\r\n            $submitter.removeClass('disabled');\r\n            $submitter.qtip('disable');\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Allow to enable / disable the access checkbox based on the state of the grant privilege\r\n     * @param {jQuery|Element|String} container\r\n     * @private\r\n     */\r\n    var _disableAccessOnGrant = function (container) {\r\n        var $container = $(container);\r\n\r\n        var $managersChecked = $container.find('.privilege-GRANT:checked').closest('tr');\r\n        var $cantChangeWrite = $managersChecked.find('.privilege-WRITE');\r\n        var $cantChangeRead = $managersChecked.find('.privilege-READ');\r\n\r\n        var $managers = $container.find('.privilege-GRANT').not(':checked').closest('tr');\r\n        var $canChangeWrite = $managers.find('.privilege-WRITE');\r\n        var $canChangeRead = $managers.find('.privilege-READ');\r\n\r\n        $canChangeWrite.removeClass('disabled');\r\n        $canChangeRead.removeClass('disabled');\r\n\r\n        $cantChangeWrite.addClass('disabled').attr('checked', true);\r\n        $cantChangeRead.addClass('disabled').attr('checked', true);\r\n\r\n        _preventManagerRemoval($container);\r\n        _disableAccessOnWrite($container);\r\n    };\r\n\r\n    /**\r\n     * Allow to enable / disable the access checkbox based on the state of the write privilege\r\n     * @param {jQuery|Element|String} container\r\n     * @private\r\n     */\r\n    var _disableAccessOnWrite = function (container) {\r\n        var $container = $(container);\r\n\r\n        var $writersChecked = $container.find('.privilege-WRITE:checked').closest('tr');\r\n        var $cantChangeRead = $writersChecked.find('.privilege-READ');\r\n\r\n        var $writers = $container.find('.privilege-WRITE').not(':checked').closest('tr');\r\n        var $canChangeRead = $writers.find('.privilege-READ');\r\n\r\n        $canChangeRead.removeClass('disabled');\r\n\r\n        $cantChangeRead.addClass('disabled').attr('checked', true);\r\n    };\r\n\r\n    /**\r\n     * Delete a permission row for a user/role\r\n     * @param  {DOM Element} element DOM element that triggered the function\r\n     * @private\r\n     */\r\n    var _deletePermission = function (element) {\r\n        // 1. Get the user / role\r\n        var $this = $(element);\r\n        var $container = $this.closest('table');\r\n        var type = $this.data('acl-type');\r\n        var user = $this.data('acl-user');\r\n        var label = $this.data('acl-label');\r\n\r\n        // 2. Remove it from the list\r\n        if (!_.isEmpty(type) && !_.isEmpty(user) && !_.isEmpty(label)) {\r\n            $this.closest('tr').remove();\r\n        }\r\n\r\n        _preventManagerRemoval($container);\r\n        _manageTabsDisplay();\r\n    };\r\n\r\n    /**\r\n     * Checks if a permission has already been added to the list.\r\n     * Highlight the list if the permission is already in the list.\r\n     * @param {jQuery|Element|String} container\r\n     * @param {String} type role/user regarding what it will be added.\r\n     * @param {String} id The identifier of the resource.\r\n     * @returns {boolean} Returns true if the permission is already in the list\r\n     * @private\r\n     */\r\n    var _checkPermission = function (container, type, id) {\r\n        var $btn = $(container).find('button[data-acl-user=\"' + id + '\"]'),\r\n            $line = $btn.closest('tr');\r\n\r\n        if ($line.length) {\r\n            $line.effect('highlight', {}, 1500);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    };\r\n\r\n    /**\r\n     * Add a new lines into the permissions table regarding what is selected into the add-* select\r\n     * @param {jQuery|Element|String} container\r\n     * @param {String} type role/user regarding what it will be added.\r\n     * @param {String} id The identifier of the resource.\r\n     * @param {String} label The label of the resource.\r\n     * @private\r\n     */\r\n    var _addPermission = function (container, type, id, label) {\r\n        var $container = $(container),\r\n            $body = $container.find('tbody').first();\r\n\r\n        // only add the permission if it's not already present in the list\r\n        if (!_checkPermission($container, type, id)) {\r\n            $body.append(lineTpl({\r\n                type: type,\r\n                user: id,\r\n                label: label\r\n            }));\r\n            _disableAccessOnGrant($container);\r\n            _manageTabsDisplay();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Ensures that if you give the manage (GRANT) permission, access (WRITE and READ) permissions are given too\r\n     * Listens all clicks on delete buttons to call the _deletePermission function\r\n     * @param {jQuery|Element|String} container The container on which apply the listeners\r\n     * @private\r\n     */\r\n    var _installListeners = function(container) {\r\n        var $container = $(container);\r\n        $container.on('click', '.privilege-GRANT:not(.disabled) ', function () {\r\n            _disableAccessOnGrant($container);\r\n        }).on('click', '.privilege-WRITE:not(.disabled) ', function () {\r\n            _disableAccessOnWrite($container);\r\n        }).on('click', '.delete_permission:not(.disabled)', function (event) {\r\n            event.preventDefault();\r\n            _deletePermission(this);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Manages the display of tabs.\r\n     * If the total amount of lines per tables is too big, display the tabs. Otherwise, hide them.\r\n     * @private\r\n     */\r\n    var _manageTabsDisplay = function() {\r\n        var $tabs = $('.permission-tabs');\r\n        var needsTabs = $tabs.find('.privilege-GRANT').length > linesThreshold;\r\n        var $focused, index;\r\n\r\n        if (needsTabs) {\r\n            $tabs.find('ul').show();\r\n            if (!$tabs.hasClass('ui-tabs')) {\r\n                // get the current focused panel\r\n                $focused = $tabs.find(':focus').closest('.permission-tabs-panel');\r\n                index = Math.max(0, $focused.index() - 1);\r\n\r\n                // install the tabs, but keep the current panel focused\r\n                $tabs.tabs({\r\n                    // use two options to be compatible with both older and current version of jQueryUI\r\n                    selected: index,\r\n                    active: index\r\n                });\r\n            }\r\n            $('.msg-edit-area label span').hide();\r\n        } else {\r\n            if ($tabs.hasClass('ui-tabs')) {\r\n                $tabs.find('.ui-tabs-hide').removeClass('ui-tabs-hide');\r\n                $tabs.tabs('destroy');\r\n            }\r\n            $tabs.find('ul').hide();\r\n            $('.msg-edit-area label span').show();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Installs a search purpose autocompleter onto an element.\r\n     * @param {jQuery|Element|String} element The element on which install the autocompleter\r\n     * @param {Object} options A list of options to set\r\n     * @returns {Autocompleter} Returns the instance of the autocompleter component\r\n     */\r\n    var _searchFactory = function (element, options) {\r\n        if (_.isFunction(options)) {\r\n            options = {\r\n                onSelectItem: options\r\n            };\r\n        }\r\n\r\n        options = _.assign({\r\n            isProvider: true,\r\n            preventSubmit: true\r\n        }, options || {});\r\n\r\n        return autocomplete(element, options);\r\n    };\r\n\r\n    var mainCtrl = {\r\n        'start': function () {\r\n\r\n            var $container = $('.permission-container');\r\n            var $form = $('form', $container);\r\n            var $submitter = $(':submit', $form);\r\n\r\n            _disableAccessOnGrant('#permissions-table-users');\r\n            _disableAccessOnGrant('#permissions-table-roles');\r\n\r\n            // install autocomplete for user add\r\n            _searchFactory('#add-user', function (event, value, label) {\r\n                $('#add-user').focus();\r\n                _addPermission('#permissions-table-users', 'user', value, label);\r\n            });\r\n\r\n            // install autocomplete for role add\r\n            _searchFactory('#add-role', function (event, value, label) {\r\n                $('#add-role').focus();\r\n                _addPermission('#permissions-table-roles', 'role', value, label);\r\n            });\r\n\r\n            // ensure that if you give the manage (GRANT) permission, access (WRITE and READ) permissions are given too\r\n            _installListeners('#permissions-table-users');\r\n            _installListeners('#permissions-table-roles');\r\n\r\n            _manageTabsDisplay();\r\n\r\n            $form.on('submit', function (e) {\r\n                e.preventDefault();\r\n                e.stopImmediatePropagation();\r\n            });\r\n            $submitter.on('click', function (e) {\r\n                e.preventDefault();\r\n\r\n                if ($submitter.hasClass('disabled')) {\r\n                    return;\r\n                }\r\n\r\n                if (!_checkManagers('form')) {\r\n                    feedback().error(errorMsgManagePermission);\r\n                   return;\r\n                }\r\n\r\n                $submitter.addClass('disabled');\r\n\r\n                $.ajax({\r\n                    url : $form.attr('action'),\r\n                    type : 'POST',\r\n                    data : $form.serialize(),\r\n                    global : false\r\n                }).done(function () {\r\n                    feedback().success(__('Permissions saved'));\r\n                }).fail(function(jqXHR, textStatus, errorThrown) {\r\n                    var error = httpErrorParser.parse(jqXHR, textStatus, errorThrown);\r\n                    feedback().error(error.message);\r\n                })\r\n                .complete(function () {\r\n                    $submitter.removeClass('disabled');\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    return mainCtrl;\r\n});\r\n\n"]}